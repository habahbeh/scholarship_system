{% extends 'applications/apply_tabs/base_tabs.html' %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}

{% block application_content %}
<h4 class="mb-4">{% trans "المستندات المطلوبة" %}</h4>

{% if not application.documents.all %}
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle me-2"></i>
    {% trans "يجب رفع المستندات المطلوبة على الأقل (السيرة الذاتية، إثبات الهوية، شهادة الثانوية العامة، شهادة البكالوريوس)." %}
</div>
{% endif %}

<div class="required-documents mb-4">
    <h5>{% trans "المستندات المطلوبة" %}</h5>
    <ul class="list-group">
        <li class="list-group-item {% if 'cv' in application.documents.values_list('document_type', flat=True) %}list-group-item-success{% endif %}">
            <i class="fas {% if 'cv' in application.documents.values_list('document_type', flat=True) %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
            {% trans "السيرة الذاتية" %}
        </li>
        <li class="list-group-item {% if 'personal_id' in application.documents.values_list('document_type', flat=True) %}list-group-item-success{% endif %}">
            <i class="fas {% if 'personal_id' in application.documents.values_list('document_type', flat=True) %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
            {% trans "إثبات الهوية" %}
        </li>
        <li class="list-group-item {% if 'high_school_certificate' in application.documents.values_list('document_type', flat=True) %}list-group-item-success{% endif %}">
            <i class="fas {% if 'high_school_certificate' in application.documents.values_list('document_type', flat=True) %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
            {% trans "شهادة الثانوية العامة" %}
        </li>
        <li class="list-group-item {% if 'bachelors_certificate' in application.documents.values_list('document_type', flat=True) %}list-group-item-success{% endif %}">
            <i class="fas {% if 'bachelors_certificate' in application.documents.values_list('document_type', flat=True) %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
            {% trans "شهادة البكالوريوس" %}
        </li>
    </ul>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ formset.management_form }}

    <div id="document_formset">
        {% for form in formset %}
        <div class="document-row border rounded p-4 mb-4 bg-light">
            <div class="document-header d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 document-title fw-bold">
                    {% if form.instance.pk %}
                        {{ form.instance.name }}
                    {% else %}
                        {% trans "مستند جديد" %}
                    {% endif %}
                </h5>
                <div>
                    <button type="button" class="btn btn-danger btn-sm delete-document" {% if forloop.first and formset|length == 1 %}style="display: none;"{% endif %}>
                        <i class="fas fa-trash-alt"></i> {% trans "حذف" %}
                    </button>
                </div>
            </div>

            {{ form.id }}
            {{ form.DELETE.as_hidden }}

            <div class="row">
                <div class="col-md-4 mb-3">
                    {{ form.document_type|as_crispy_field }}
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.name|as_crispy_field }}
                </div>
                <div class="col-md-4 mb-3">
                    <div class="form-check mt-4">
                        {{ form.is_required }}
                        <label class="form-check-label" for="{{ form.is_required.id_for_label }}">
                            {{ form.is_required.label }}
                        </label>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mb-3">
                    {{ form.description|as_crispy_field }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mb-3">
                    {{ form.file|as_crispy_field }}
                </div>
            </div>

            <div class="row related-qualifications">
                <div class="col-md-12 mb-3">
                    <h6>{% trans "ربط المستند بالمؤهلات الأكاديمية (اختياري)" %}</h6>
                </div>

                {% if high_school_qualifications %}
                <div class="col-md-6 mb-3">
                    {{ form.high_school_qualification|as_crispy_field }}
                </div>
                {% endif %}

                {% if bachelor_qualifications %}
                <div class="col-md-6 mb-3">
                    {{ form.bachelor_qualification|as_crispy_field }}
                </div>
                {% endif %}

                {% if master_qualifications %}
                <div class="col-md-6 mb-3">
                    {{ form.master_qualification|as_crispy_field }}
                </div>
                {% endif %}

                {% if other_certificates %}
                <div class="col-md-6 mb-3">
                    {{ form.other_certificate|as_crispy_field }}
                </div>
                {% endif %}

                {% if language_proficiencies %}
                <div class="col-md-6 mb-3">
                    {{ form.language_proficiency|as_crispy_field }}
                </div>
                {% endif %}
            </div>

            {% if form.instance.file %}
            <div class="row">
                <div class="col-md-12">
                    <div class="alert alert-success">
                        <i class="fas fa-file me-2"></i>
                        {% trans "تم رفع الملف بنجاح:" %}
                        <a href="{{ form.instance.file.url }}" target="_blank">{{ form.instance.file.name|slice:"20:" }}</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <div class="text-center my-4">
        <button type="button" class="btn btn-success" id="add_document">
            <i class="fas fa-plus me-1"></i> {% trans "إضافة مستند جديد" %}
        </button>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <a href="{% if is_update %}{% url 'applications:update_application_tabs' application.id %}{% else %}{% url 'applications:apply_tabs' scholarship.id %}{% endif %}?step=language" class="btn btn-outline-secondary btn-steps">
            <i class="fas fa-arrow-right me-1"></i> {% trans "السابق: الكفاءة اللغوية" %}
        </a>
        <button type="submit" class="btn btn-primary btn-steps">
            <i class="fas fa-arrow-left me-1"></i> {% trans "التالي: معاينة الطلب" %}
        </button>
    </div>
</form>
{% endblock %}

{% block step_js %}
document.addEventListener('DOMContentLoaded', function() {
    const formset = document.getElementById('document_formset');

    // تحديد عدد النماذج الحالية والحد الأقصى
    const totalFormsInput = document.getElementById('id_documents-TOTAL_FORMS');
    const maxNumForms = parseInt(document.getElementById('id_documents-MAX_NUM_FORMS').value || '1000');

    // زر إضافة مستند جديد
    const addDocumentBtn = document.getElementById('add_document');

    // إضافة مستند جديد
    addDocumentBtn.addEventListener('click', function() {
        const totalForms = parseInt(totalFormsInput.value);

        if (totalForms < maxNumForms) {
            // نسخ آخر نموذج
            const lastForm = formset.querySelector('.document-row:last-child');
            const newForm = lastForm.cloneNode(true);

            // تحديث المعرفات والأسماء
            newForm.querySelectorAll('input, select, textarea, label').forEach(input => {
                // تحديث الاسم والمعرف
                if (input.name) {
                    const oldName = input.name;
                    const newName = oldName.replace(/documents-\d+-/, `documents-${totalForms}-`);
                    input.name = newName;
                }

                if (input.id) {
                    const oldId = input.id;
                    const newId = oldId.replace(/id_documents-\d+-/, `id_documents-${totalForms}-`);
                    input.id = newId;
                }

                // تحديث for للعناوين
                if (input.htmlFor) {
                    const oldFor = input.htmlFor;
                    const newFor = oldFor.replace(/id_documents-\d+-/, `id_documents-${totalForms}-`);
                    input.htmlFor = newFor;
                }

                // إعادة تعيين القيم
                if (input.type !== 'hidden') {
                    if (input.type === 'checkbox') {
                        if (input.name.includes('DELETE')) {
                            input.checked = false;
                        } else if (input.name.includes('is_required')) {
                            input.checked = true; // المستندات مطلوبة افتراضيًا
                        } else {
                            input.checked = false;
                        }
                    } else if (input.type === 'file') {
                        // نحتاج إلى إنشاء عنصر ملف جديد لتجنب قيود الأمان
                        const newFileInput = document.createElement('input');
                        newFileInput.type = 'file';
                        newFileInput.name = input.name;
                        newFileInput.id = input.id;
                        newFileInput.className = input.className;
                        input.parentNode.replaceChild(newFileInput, input);
                    } else if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0;
                    } else {
                        input.value = '';
                    }
                } else if (input.name && input.name.includes('id')) {
                    input.value = ''; // تفريغ معرف السجل
                }
            });

            // إعادة تعيين عنوان المستند
            const title = newForm.querySelector('.document-title');
            if (title) {
                title.innerText = 'مستند جديد';
            }

            // إزالة رسالة تأكيد رفع الملف إن وجدت
            const successAlert = newForm.querySelector('.alert-success');
            if (successAlert) {
                successAlert.remove();
            }

            // التأكد من إظهار زر الحذف
            const deleteBtn = newForm.querySelector('.delete-document');
            deleteBtn.style.display = 'inline-block';

            // إضافة النموذج للصفحة
            formset.appendChild(newForm);

            // تحديث عدد النماذج
            totalFormsInput.value = totalForms + 1;

            // إضافة مستمعي الأحداث للنموذج الجديد
            initializeDocumentForm(newForm);
        } else {
            alert('{% trans "تم الوصول للحد الأقصى من المستندات" %}');
        }
    });

    // تهيئة مستمعي الأحداث لكل نموذج
    formset.querySelectorAll('.document-row').forEach(row => {
        initializeDocumentForm(row);
    });

    // دالة لتهيئة النموذج
    function initializeDocumentForm(form) {
        // مستمع حدث للحذف
        const deleteBtn = form.querySelector('.delete-document');
        deleteBtn.addEventListener('click', function() {
            deleteDocument(form);
        });

        // مستمع حدث لتغيير نوع المستند
        const docTypeSelect = form.querySelector('select[id$="-document_type"]');
        if (docTypeSelect) {
            docTypeSelect.addEventListener('change', function() {
                updateDocumentName(form);
            });
        }
    }

    // دالة لحذف مستند
    function deleteDocument(row) {
        // تعليم النموذج للحذف
        const deleteCheckbox = row.querySelector('input[id$="-DELETE"]');
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
        }

        // إخفاء النموذج
        row.style.display = 'none';
    }

    // دالة لتحديث اسم المستند بناءً على نوعه
    function updateDocumentName(form) {
        const docType = form.querySelector('select[id$="-document_type"]');
        const nameInput = form.querySelector('input[id$="-name"]');

        if (docType && nameInput && docType.selectedIndex > 0) {
            // الحصول على النص المعروض للخيار المحدد
            const selectedOption = docType.options[docType.selectedIndex];
            nameInput.value = selectedOption.text;
        }
    }
});
{% endblock %}