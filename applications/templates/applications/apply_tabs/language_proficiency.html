{% extends 'applications/apply_tabs/base_tabs.html' %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}

{% block application_content %}
<h4 class="mb-4">{% trans "الكفاءة اللغوية" %}</h4>

<div class="alert alert-info mb-4">
  <i class="fas fa-info-circle me-2"></i>
  {% trans "يرجى إضافة معلومات الكفاءة اللغوية. يجب إضافة اللغة الإنجليزية كحد أدنى." %}
</div>

<form method="post" id="languageForm">
  {% csrf_token %}
  
  {{ formset.management_form }}
  
  <div id="language_proficiency_formset">
    {% for form in formset %}
      <div class="language-row" data-form-index="{{ forloop.counter0 }}">
        <div class="language-header">
          <h5 class="mb-0 language-title">
            {% if form.instance.pk %}
              {% if form.instance.is_english %}
                {% trans "اللغة الإنجليزية" %}
              {% else %}
                {% if form.instance.other_language == 'other' %}
                  {{ form.instance.other_language_name }}
                {% else %}
                  {{ form.instance.get_other_language_display }}
                {% endif %}
              {% endif %}
            {% else %}
              {% trans "لغة جديدة" %}
            {% endif %}
          </h5>
          <div>
            <button type="button" class="btn btn-danger btn-sm delete-language" {% if forloop.first and formset|length == 1 %}style="display: none;"{% endif %}>
              <i class="fas fa-trash-alt"></i> {% trans "حذف" %}
            </button>
          </div>
        </div>
        
        {{ form.id }}
        {{ form.DELETE.as_hidden }}
        
        <div class="row mb-3">
          <div class="col-md-12">
            {{ form.is_english|as_crispy_field }}
          </div>
        </div>
        
        <!-- حقول اللغة الإنجليزية -->
        <div class="english-fields">
          <div class="row">
            <div class="col-md-6 mb-3">
              {{ form.test_type|as_crispy_field }}
            </div>
            <div class="col-md-6 mb-3 other-test-fields">
              {{ form.other_test_name|as_crispy_field }}
            </div>
            <div class="col-md-6 mb-3">
              {{ form.test_date|as_crispy_field }}
            </div>
            <div class="col-md-6 mb-3">
              {{ form.overall_score|as_crispy_field }}
            </div>
            <div class="col-md-12 mb-3">
              {{ form.reference_number|as_crispy_field }}
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-3 mb-3">
              {{ form.reading_score|as_crispy_field }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.listening_score|as_crispy_field }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.speaking_score|as_crispy_field }}
            </div>
            <div class="col-md-3 mb-3">
              {{ form.writing_score|as_crispy_field }}
            </div>
          </div>
        </div>
        
        <!-- حقول اللغات الأخرى -->
        <div class="other-language-fields">
          <div class="row">
            <div class="col-md-6 mb-3">
              {{ form.other_language|as_crispy_field }}
            </div>
            <div class="col-md-6 mb-3 other-language-name-fields">
              {{ form.other_language_name|as_crispy_field }}
            </div>
            <div class="col-md-12 mb-3">
              {{ form.proficiency_level|as_crispy_field }}
            </div>
          </div>
        </div>
        
        <!-- معلومات إضافية -->
        <div class="row mt-3">
          <div class="col-md-12">
            {{ form.additional_info|as_crispy_field }}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  
  <div class="text-center my-4">
    <button type="button" class="btn btn-success" id="add_language">
      <i class="fas fa-plus me-1"></i> {% trans "إضافة لغة جديدة" %}
    </button>
  </div>
  
  <div class="d-flex justify-content-between mt-4">
    <a href="{% if is_update %}{% url 'applications:update_application_tabs' application.id %}{% else %}{% url 'applications:apply_tabs' scholarship.id %}{% endif %}?step=academic" class="btn btn-outline-secondary btn-steps">
      <i class="fas fa-arrow-right me-1"></i> {% trans "السابق" %}
    </a>
    <button type="submit" class="btn btn-primary btn-steps">
      <i class="fas fa-arrow-left me-1"></i> {% trans "التالي: المستندات" %}
    </button>
  </div>
</form>
{% endblock %}

{% block step_js %}
// تغيير حقول اللغة حسب النوع المحدد
function toggleLanguageFields() {
  const languageRows = document.querySelectorAll('.language-row');
  
  languageRows.forEach(row => {
    const isEnglishCheckbox = row.querySelector('input[id$="-is_english"]');
    const englishFields = row.querySelector('.english-fields');
    const otherLanguageFields = row.querySelector('.other-language-fields');
    const languageTitle = row.querySelector('.language-title');
    
    // تغيير العنوان والحقول المعروضة
    if (isEnglishCheckbox.checked) {
      englishFields.style.display = 'block';
      otherLanguageFields.style.display = 'none';
      languageTitle.innerText = '{% trans "اللغة الإنجليزية" %}';
      
      // التحقق من نوع الاختبار
      const testTypeSelect = row.querySelector('select[id$="-test_type"]');
      const otherTestFields = row.querySelector('.other-test-fields');
      
      if (testTypeSelect.value === 'other') {
        otherTestFields.style.display = 'block';
      } else {
        otherTestFields.style.display = 'none';
      }
      
      // إضافة مستمع لتغيير نوع الاختبار
      testTypeSelect.addEventListener('change', function() {
        if (this.value === 'other') {
          otherTestFields.style.display = 'block';
        } else {
          otherTestFields.style.display = 'none';
        }
      });
    } else {
      englishFields.style.display = 'none';
      otherLanguageFields.style.display = 'block';
      
      // تحديث العنوان بناءً على اللغة المحددة
      const otherLanguageSelect = row.querySelector('select[id$="-other_language"]');
      const otherLanguageNameFields = row.querySelector('.other-language-name-fields');
      
      if (otherLanguageSelect.value === 'other') {
        otherLanguageNameFields.style.display = 'block';
        // محاولة الحصول على قيمة اسم اللغة المخصصة
        const otherLanguageNameInput = row.querySelector('input[id$="-other_language_name"]');
        if (otherLanguageNameInput.value) {
          languageTitle.innerText = otherLanguageNameInput.value;
        } else {
          languageTitle.innerText = '{% trans "لغة أخرى" %}';
        }
      } else {
        otherLanguageNameFields.style.display = 'none';
        // الحصول على النص المعروض من القائمة المنسدلة
        const selectedOption = otherLanguageSelect.options[otherLanguageSelect.selectedIndex];
        languageTitle.innerText = selectedOption.text;
      }
      
      // إضافة مستمع لتغيير نوع اللغة الأخرى
      otherLanguageSelect.addEventListener('change', function() {
        if (this.value === 'other') {
          otherLanguageNameFields.style.display = 'block';
        } else {
          otherLanguageNameFields.style.display = 'none';
          // تحديث العنوان
          const selectedOption = this.options[this.selectedIndex];
          languageTitle.innerText = selectedOption.text;
        }
      });
      
      // إضافة مستمع لتغيير اسم اللغة المخصصة
      const otherLanguageNameInput = row.querySelector('input[id$="-other_language_name"]');
      otherLanguageNameInput.addEventListener('input', function() {
        if (this.value) {
          languageTitle.innerText = this.value;
        } else {
          languageTitle.innerText = '{% trans "لغة أخرى" %}';
        }
      });
    }
  });
}

// تنفيذ عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
  const formset = document.getElementById('language_proficiency_formset');
  
  // تحديد عدد النماذج الحالية والحد الأقصى
  const totalFormsInput = document.getElementById('id_languageproficiency_set-TOTAL_FORMS');
  const maxNumForms = parseInt(document.getElementById('id_languageproficiency_set-MAX_NUM_FORMS').value);
  
  // زر إضافة لغة جديدة
  const addLanguageBtn = document.getElementById('add_language');
  
  // تنفيذ toggleLanguageFields عند بدء الصفحة
  toggleLanguageFields();
  
  // إضافة مستمعي الأحداث لتغيير نوع اللغة
  formset.querySelectorAll('input[id$="-is_english"]').forEach(checkbox => {
    checkbox.addEventListener('change', toggleLanguageFields);
  });
  
  // إضافة لغة جديدة
  addLanguageBtn.addEventListener('click', function() {
    const totalForms = parseInt(totalFormsInput.value);
    
    // التحقق من عدم تجاوز الحد الأقصى
    if (totalForms < maxNumForms) {
      // نسخ آخر نموذج
      const lastForm = formset.querySelector('.language-row:last-child');
      const newForm = lastForm.cloneNode(true);
      
      // تحديث المعرفات والأسماء
      newForm.setAttribute('data-form-index', totalForms);
      newForm.querySelectorAll('input, select, textarea').forEach(input => {
        // استبدال الرقم في المعرف والاسم
        const oldName = input.getAttribute('name');
        const oldId = input.getAttribute('id');
        
        if (oldName) {
          const newName = oldName.replace(/-\d+-/, `-${totalForms}-`);
          input.setAttribute('name', newName);
        }
        
        if (oldId) {
          const newId = oldId.replace(/-\d+-/, `-${totalForms}-`);
          input.setAttribute('id', newId);
        }
        
        // إعادة تعيين القيم
        if (input.type !== 'hidden') {
          if (input.type === 'checkbox') {
            input.checked = false;
          } else {
            input.value = '';
          }
        }
      });
      
      // إعادة تعيين المسميات
      newForm.querySelectorAll('label').forEach(label => {
        const forAttr = label.getAttribute('for');
        if (forAttr) {
          const newFor = forAttr.replace(/-\d+-/, `-${totalForms}-`);
          label.setAttribute('for', newFor);
        }
      });
      
      // إخفاء العنصر المخفي DELETE
      const deleteCheckbox = newForm.querySelector('input[id$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = false;
      }
      
      // إعادة تعيين عنوان اللغة
      const languageTitle = newForm.querySelector('.language-title');
      languageTitle.innerText = '{% trans "لغة جديدة" %}';
      
      // افتراض أن اللغة الجديدة ليست الإنجليزية (لأن الإنجليزية يجب أن تكون موجودة بالفعل)
      const isEnglishCheckbox = newForm.querySelector('input[id$="-is_english"]');
      isEnglishCheckbox.checked = false;
      
      // إضافة المستمع لنوع اللغة
      isEnglishCheckbox.addEventListener('change', toggleLanguageFields);
      
      // إضافة مستمع لزر الحذف
      const deleteBtn = newForm.querySelector('.delete-language');
      deleteBtn.style.display = 'inline-block';
      deleteBtn.addEventListener('click', function() {
        deleteLanguage(newForm);
      });
      
      // إضافة النموذج الجديد للمستند
      formset.appendChild(newForm);
      
      // تحديث عدد النماذج الكلي
      totalFormsInput.value = totalForms + 1;
      
      // تنفيذ toggleLanguageFields بعد إضافة النموذج
      toggleLanguageFields();
    } else {
      alert('{% trans "تم الوصول للحد الأقصى من اللغات" %}');
    }
  });
  
  // حذف لغة
  function deleteLanguage(row) {
    const totalForms = parseInt(totalFormsInput.value);
    
    // إذا كان هناك أكثر من نموذج واحد
    if (totalForms > 1) {
      const deleteCheckbox = row.querySelector('input[id$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
      }
      row.style.display = 'none';
    } else {
      alert('{% trans "يجب إضافة لغة واحدة على الأقل" %}');
    }
  }
  
  // إضافة مستمعي الأحداث لأزرار الحذف
  formset.querySelectorAll('.delete-language').forEach(btn => {
    btn.addEventListener('click', function() {
      const row = this.closest('.language-row');
      deleteLanguage(row);
    });
  });
});
{% endblock %}